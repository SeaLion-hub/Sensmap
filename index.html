<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Railway ë°°í¬ ì‹œ ìë™ìœ¼ë¡œ ì˜¬ë°”ë¥¸ URLì´ ì„¤ì •ë˜ë„ë¡ ìˆ˜ì • -->
    <meta name="server-url" content="">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sensmap - Advanced Sensory Navigation</title>
    
    <!-- ë™ì ìœ¼ë¡œ ì„œë²„ URLì„ ê°ì§€í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // Railway ë°°í¬ í™˜ê²½ì„ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ ì„œë²„ URL ì„¤ì •
        (function() {
            const currentHost = window.location.hostname;
            const currentProtocol = window.location.protocol;
            
            // Railway ë°°í¬ í™˜ê²½ ê°ì§€
            if (currentHost.includes('railway.app') || currentHost.includes('up.railway.app')) {
                // Railway í™˜ê²½: ê°™ì€ ë„ë©”ì¸ ì‚¬ìš©
                window.SENSMAP_SERVER_URL = `${currentProtocol}//${currentHost}`;
            }
            // ë¡œì»¬ ê°œë°œ í™˜ê²½
            else if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                window.SENSMAP_SERVER_URL = 'http://localhost:3000';
            }
            // ê¸°íƒ€ í”„ë¡œë•ì…˜ í™˜ê²½
            else {
                window.SENSMAP_SERVER_URL = `${currentProtocol}//${currentHost}`;
            }
            
            console.log('ğŸ”— ì„œë²„ URL ì„¤ì •:', window.SENSMAP_SERVER_URL);
        })();
    </script>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—ºï¸</text></svg>">
    
    <!-- Meta tags for better SEO and social sharing -->
    <meta name="description" content="Sensmap - ê°ê° ì¹œí™”ì  ë‚´ë¹„ê²Œì´ì…˜ì„ í†µí•´ ë” ì¾Œì í•œ ê²½ë¡œë¥¼ ì°¾ì•„ë³´ì„¸ìš”">
    <meta name="keywords" content="ê°ê°ì§€ë„, ì ‘ê·¼ì„±, ë‚´ë¹„ê²Œì´ì…˜, ì¾Œì í•œê²½ë¡œ, ê°ê°ì¹œí™”ì ">
    <meta name="author" content="Sensmap Team">
    
    <!-- Open Graph tags -->
    <meta property="og:title" content="Sensmap - Advanced Sensory Navigation">
    <meta property="og:description" content="ê°ê° ì¹œí™”ì  ë‚´ë¹„ê²Œì´ì…˜ì„ í†µí•´ ë” ì¾Œì í•œ ê²½ë¡œë¥¼ ì°¾ì•„ë³´ì„¸ìš”">
    <meta property="og:type" content="website">
    
    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- Clerk CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@clerk/clerk-js@4.70.0/dist/clerk.css" />
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- Preconnect for better performance -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <style>
        /* ì¸ì¦ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .auth-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .auth-title {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .auth-description {
            margin-bottom: 2rem;
            color: #666;
            line-height: 1.5;
        }
        
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .loading-auth {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-auth .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* íˆë“  í´ë˜ìŠ¤ */
        .hidden {
            display: none !important;
        }
        
        /* Clerk ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .cl-component {
            width: 100% !important;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #c33;
            text-align: center;
        }

        /* ì•Œë¦¼ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fbbf24;
            color: #92400e;
            padding: 12px 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 10001;
            font-size: 14px;
        }

        .alert-banner.warning {
            background: #fbbf24;
            color: #92400e;
        }

        .alert-banner.error {
            background: #ef4444;
            color: white;
        }

        .alert-banner.info {
            background: #3b82f6;
            color: white;
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .alert-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (ì¸ì¦ í™•ì¸ ì¤‘) -->
    <div id="authLoadingOverlay" class="loading-auth">
        <div class="spinner"></div>
        <div style="font-size: 16px; color: #666;">ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
    </div>

    <!-- ì¸ì¦ ì˜¤ë²„ë ˆì´ -->
    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-container">
            <h2 class="auth-title">ğŸ—ºï¸ Sensmapì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p class="auth-description">ê°ê° ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.<br>ê°œì¸ ë°ì´í„°ëŠ” ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.</p>
            <div id="clerk-signin"></div>
            <div id="auth-error" class="error-message hidden">
                ì¸ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™˜ê²½ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ -->
    <div id="userInfo" class="user-info hidden">
        <img id="userAvatar" class="user-avatar" src="" alt="ì‚¬ìš©ì ì•„ë°”íƒ€">
        <span id="userName" class="user-name">ì‚¬ìš©ì</span>
        <button id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="hidden">
        <!-- Tutorial Overlay -->
        <div class="tutorial-overlay" id="tutorialOverlay">
            <div class="tutorial-modal">
                <div class="tutorial-header">
                    <h2><i class="fas fa-graduation-cap"></i> Sensmap ì‚¬ìš©ë²•</h2>
                </div>
                <div class="tutorial-content">
                    <div class="tutorial-step active" data-step="1">
                        <div class="tutorial-icon">ğŸ—ºï¸</div>
                        <h3>ì§€ë„ì—ì„œ ê°ê° ì •ë³´ í™•ì¸</h3>
                        <p>ìƒ‰ìƒìœ¼ë¡œ í‘œì‹œëœ ë§ˆì»¤ë¥¼ í†µí•´ ê° ì§€ì—­ì˜ ì†ŒìŒ, ë¹›, ëƒ„ìƒˆ, í˜¼ì¡ë„ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íˆíŠ¸ë§µê³¼ ê°ê°ë³„ ë³´ê¸° ëª¨ë“œë¥¼ ì „í™˜í•´ë³´ì„¸ìš”.</p>
                    </div>
                    <div class="tutorial-step" data-step="2">
                        <div class="tutorial-icon">â•</div>
                        <h3>ê°ê° ì •ë³´ ì¶”ê°€í•˜ê¸°</h3>
                        <p>ì§€ë„ë¥¼ í´ë¦­í•˜ê³  íŒì—…ì—ì„œ "ê°ê° ì •ë³´ ì¶”ê°€"ë¥¼ ì„ íƒí•˜ì—¬ í˜„ì¬ ìœ„ì¹˜ì˜ ê°ê° ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì¼ì‹œì  ë˜ëŠ” ì§€ì†ì  ì •ë³´ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    <div class="tutorial-step" data-step="3">
                        <div class="tutorial-icon">ğŸ›£ï¸</div>
                        <h3>ê°ê° ì¹œí™”ì  ê²½ë¡œ ì°¾ê¸°</h3>
                        <p>ê²½ë¡œ ë²„íŠ¼ì„ í´ë¦­í•˜ê³  ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ë©´ ê°ê° ìš°ì„ , ê· í˜•, ì‹œê°„ ìš°ì„  ë“± ë‹¤ì–‘í•œ ê²½ë¡œ ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="tutorial-step" data-step="4">
                        <div class="tutorial-icon">âš™ï¸</div>
                        <h3>ê°œì¸ í”„ë¡œí•„ ì„¤ì •</h3>
                        <p>í–„ë²„ê±° ë©”ë‰´ì—ì„œ ê°ê° í”„ë¡œí•„ì„ ì„¤ì •í•˜ì—¬ ê°œì¸ì˜ ê°ê° ë¯¼ê°ë„ì— ë§ëŠ” ë§ì¶¤í˜• ì¶”ì²œì„ ë°›ìœ¼ì„¸ìš”. ì ‘ê·¼ì„± ì˜µì…˜ë„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div class="tutorial-navigation">
                    <button class="tutorial-btn secondary" id="tutorialPrev">ì´ì „</button>
                    <div class="tutorial-dots">
                        <span class="dot active" data-step="1"></span>
                        <span class="dot" data-step="2"></span>
                        <span class="dot" data-step="3"></span>
                        <span class="dot" data-step="4"></span>
                    </div>
                    <button class="tutorial-btn primary" id="tutorialNext">ë‹¤ìŒ</button>
                </div>
                <button class="tutorial-skip" id="tutorialSkip">ê±´ë„ˆë›°ê¸°</button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- Error Boundary -->
        <div class="error-boundary" id="errorBoundary" style="display: none;">
            <div class="error-content">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
                <p>ì•±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                <button onclick="location.reload()" class="primary-btn">
                    <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>

        <!-- Header Controls -->
        <header class="header-controls">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-map-marked-alt"></i>
                    Sensmap
                </div>
                
                <nav class="hamburger-menu">
                    <button class="hamburger-btn" id="hamburgerBtn" aria-label="ë©”ë‰´ ì—´ê¸°" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="hamburger-dropdown" id="hamburgerDropdown" aria-hidden="true">
                        <div class="menu-item">
                            <button class="menu-btn" id="profileMenuBtn">
                                <i class="fas fa-user-cog"></i>
                                <span>ê°ê° í”„ë¡œí•„</span>
                            </button>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-item">
                            <button class="menu-btn" id="settingsBtn">
                                <i class="fas fa-cog"></i>
                                <span>ì„¤ì •</span>
                            </button>
                        </div>
                        <div class="menu-item">
                            <button class="menu-btn" id="helpBtn">
                                <i class="fas fa-question-circle"></i>
                                <span>ë„ì›€ë§</span>
                            </button>
                        </div>
                        <div class="menu-item">
                            <button class="menu-btn" id="contactBtn">
                                <i class="fas fa-envelope"></i>
                                <span>ë¬¸ì˜í•˜ê¸°</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </div>
            
            <div class="header-center">
                <div class="display-controls">
                    <button id="heatmapBtn" class="display-btn active" title="íˆíŠ¸ë§µ ë³´ê¸°">
                        <i class="fas fa-fire"></i> íˆíŠ¸ë§µ
                    </button>
                    <div class="sensory-filter">
                        <button id="sensoryBtn" class="display-btn" title="ê°ê°ë³„ ë³´ê¸°">
                            <i class="fas fa-map-pin"></i> ê°ê°ë³„
                        </button>
                        <div id="sensoryDropdown" class="sensory-dropdown">
                             <div class="sensory-option active" data-sensory="all">
                                <span class="sensory-icon">ğŸŒ</span> ì „ì²´
                            </div>
                            <div class="sensory-option" data-sensory="noise">
                                <span class="sensory-icon">ğŸ”Š</span> ì†ŒìŒ
                            </div>
                            <div class="sensory-option" data-sensory="light">
                                <span class="sensory-icon">ğŸ’¡</span> ë¹›
                            </div>
                            <div class="sensory-option" data-sensory="odor">
                                <span class="sensory-icon">ğŸ‘ƒ</span> ëƒ„ìƒˆ
                            </div>
                            <div class="sensory-option" data-sensory="crowd">
                                <span class="sensory-icon">ğŸ‘¥</span> í˜¼ì¡ë„
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="intensity-control">
                    <label for="intensitySlider" style="font-size: 12px; color: #6b7280;">í‘œì‹œ ê°•ë„</label>
                    <input type="range" class="intensity-slider" id="intensitySlider" min="0.3" max="1" step="0.1" value="0.7" aria-label="í‘œì‹œ ê°•ë„ ì¡°ì ˆ">
                    <span id="intensityValue" style="font-size: 12px; font-weight: 600;">0.7</span>
                </div>
            </div>
            
            <div class="header-right">
                <button class="icon-btn active" id="showDataBtn" title="ë°ì´í„° í‘œì‹œ/ìˆ¨ê¹€" aria-label="ë°ì´í„° í‘œì‹œ í† ê¸€" aria-pressed="true">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="icon-btn" id="routeBtn" title="ê²½ë¡œ ì°¾ê¸°" aria-label="ê²½ë¡œ ì°¾ê¸° ëª¨ë“œ">
                    <i class="fas fa-route"></i>
                </button>
            </div>
        </header>

        <!-- Settings Panel -->
        <aside class="settings-panel" id="settingsPanel">
            <div class="panel-header">
                <div class="panel-title">ì„¤ì •</div>
                <button class="close-btn" id="closeSettingsBtn" aria-label="ì„¤ì • íŒ¨ë„ ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <section class="settings-section">
                    <h3>ì ‘ê·¼ì„± ì˜µì…˜</h3>
                    <div class="setting-option">
                        <label>
                            <input type="checkbox" id="colorBlindMode">
                            <span>ìƒ‰ë§¹ ì¹œí™” ëª¨ë“œ</span>
                        </label>
                    </div>
                    <div class="setting-option">
                        <label>
                            <input type="checkbox" id="highContrastMode">
                            <span>ê³ ëŒ€ë¹„ ëª¨ë“œ</span>
                        </label>
                    </div>
                    <div class="setting-option">
                        <label>
                            <input type="checkbox" id="reducedMotionMode">
                            <span>ì• ë‹ˆë©”ì´ì…˜ ì¤„ì´ê¸°</span>
                        </label>
                    </div>
                    <div class="setting-option">
                        <label for="textSizeSlider">í…ìŠ¤íŠ¸ í¬ê¸°</label>
                        <input type="range" id="textSizeSlider" min="0.8" max="1.5" step="0.1" value="1">
                    </div>
                </section>
            </div>
        </aside>

        <!-- Contact Modal -->
        <div class="modal-overlay" id="contactModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ë¬¸ì˜í•˜ê¸°</h3>
                    <button class="close-btn" id="closeContactBtn" aria-label="ë¬¸ì˜ ëª¨ë‹¬ ë‹«ê¸°">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Sensmapì— ëŒ€í•œ ì˜ê²¬ì´ë‚˜ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½í•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ë¶„ì˜ í”¼ë“œë°±ì´ ë” ë‚˜ì€ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“œëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>
                    <div class="contact-methods">
                        <a href="mailto:support@sensmap.app" class="contact-btn">
                            <i class="fas fa-envelope"></i>
                            ì´ë©”ì¼ë¡œ ë¬¸ì˜í•˜ê¸°
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Map Container -->
        <main id="map" role="application" aria-label="ê°ê° ì§€ë„" tabindex="0"></main>

        <!-- Sensory Data Input Panel -->
        <aside class="side-panel" id="sidePanel" aria-hidden="true">
            <div class="panel-header">
                <div class="panel-title">ê°ê° ì •ë³´ ì…ë ¥</div>
                <div class="panel-subtitle">í˜„ì¬ ìœ„ì¹˜ì˜ ê°ê° ì •ë³´ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”</div>
                <button class="close-btn" id="closePanelBtn" aria-label="íŒ¨ë„ ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="panel-content">
                <form id="sensoryForm" novalidate>
                    <div class="form-group">
                        <label class="form-label">ì •ë³´ ìœ í˜•</label>
                        <div class="type-selector">
                            <div class="type-option selected" data-type="irregular" tabindex="0" role="button" aria-pressed="true">
                                <div class="type-title">âš¡ ì¼ì‹œì </div>
                                <div class="type-desc">ê³µì‚¬, ì´ë²¤íŠ¸ ë“±<br>(ìµœëŒ€ 1ì‹œê°„)</div>
                            </div>
                            <div class="type-option" data-type="regular" tabindex="0" role="button" aria-pressed="false">
                                <div class="type-title">ğŸ¢ ì§€ì†ì </div>
                                <div class="type-desc">ê±´ë¬¼, ë„ë¡œ íŠ¹ì„±<br>(ìµœëŒ€ 6ì‹œê°„)</div>
                            </div>
                        </div>
                    </div>

                    <div class="smart-form-group" data-field="noise">
                        <div class="field-header">
                            <label class="form-label" for="noiseInput">ì†ŒìŒ ìˆ˜ì¤€</label>
                            <button type="button" class="skip-btn" data-field="noise">ê±´ë„ˆë›°ê¸°</button>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="noiseInput" name="noise" min="0" max="10" value="5" aria-describedby="noiseHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="noiseHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">0: ë§¤ìš° ì¡°ìš©í•¨, 10: ë§¤ìš° ì‹œë„ëŸ¬ì›€</small>
                    </div>

                    <div class="smart-form-group" data-field="light">
                        <div class="field-header">
                            <label class="form-label" for="lightInput">ë¹› ê°•ë„</label>
                            <button type="button" class="skip-btn" data-field="light">ê±´ë„ˆë›°ê¸°</button>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="lightInput" name="light" min="0" max="10" value="5" aria-describedby="lightHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="lightHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">0: ë§¤ìš° ì–´ë‘ì›€, 10: ë§¤ìš° ë°ìŒ</small>
                    </div>
                    
                    <div class="smart-form-group" data-field="odor">
                        <div class="field-header">
                            <label class="form-label" for="odorInput">ëƒ„ìƒˆ ì •ë„</label>
                            <button type="button" class="skip-btn" data-field="odor">ê±´ë„ˆë›°ê¸°</button>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="odorInput" name="odor" min="0" max="10" value="5" aria-describedby="odorHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="odorHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">0: ëƒ„ìƒˆ ì—†ìŒ, 10: ë§¤ìš° ê°•í•œ ëƒ„ìƒˆ</small>
                    </div>

                    <div class="smart-form-group" data-field="crowd">
                        <div class="field-header">
                            <label class="form-label" for="crowdInput">í˜¼ì¡ë„</label>
                            <button type="button" class="skip-btn" data-field="crowd">ê±´ë„ˆë›°ê¸°</button>
                        </div>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="crowdInput" name="crowd" min="0" max="10" value="5" aria-describedby="crowdHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="crowdHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">0: í•œì í•¨, 10: ë§¤ìš° í˜¼ì¡í•¨</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="durationInput">
                            ì˜ˆìƒ ì§€ì† ì‹œê°„(ë¶„)
                            <span class="optional-badge">ì„ íƒ</span>
                        </label>
                        <input type="number" class="duration-input" id="durationInput" name="duration" min="1" placeholder="ì˜ˆ: 30ë¶„, 60ë¶„ ë“± (ìµœëŒ€ 1ì‹œê°„)" aria-describedby="durationHelp">
                        <small id="durationHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">ë¹„ì›Œë‘ë©´ ê¸°ë³¸ê°’ì´ ì ìš©ë©ë‹ˆë‹¤</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="wheelchair" id="wheelchairInput">
                            <span>â™¿ íœ ì²´ì–´ ì ‘ê·¼ ì œì•½</span>
                        </label>
                    </div>

                    <button type="submit" class="primary-btn">
                        <i class="fas fa-save"></i>
                        ê°ê° ì •ë³´ ì €ì¥
                    </button>
                    
                    <button type="button" class="secondary-btn" id="cancelBtn">
                        <i class="fas fa-times"></i>
                        ì·¨ì†Œ
                    </button>
                </form>
            </div>
        </aside>

        <!-- Profile Panel -->
        <aside class="side-panel" id="profilePanel" aria-hidden="true">
            <div class="panel-header">
                <div class="panel-title">ê°ê° í”„ë¡œí•„</div>
                <div class="panel-subtitle">ê°œì¸ ë¯¼ê°ë„ë¥¼ ì„¤ì •í•˜ì—¬ ë§ì¶¤í˜• ê²½ë¡œë¥¼ ì°¾ì•„ë³´ì„¸ìš”</div>
                <button class="close-btn" id="closeProfileBtn" aria-label="íŒ¨ë„ ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="panel-content">
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label" for="noiseThreshold">ì†ŒìŒ ë¯¼ê°ë„</label>
                        <div class="slider-container">
                            <div class="range-value">5</div>
                        </div>
                        <small id="noiseThresholdHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">ë†’ì„ìˆ˜ë¡ ì†ŒìŒì— ë¯¼ê°í•¨</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lightThreshold">ë¹› ë¯¼ê°ë„</label>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="lightThreshold" name="lightThreshold" min="0" max="10" value="5" aria-describedby="lightThresholdHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="lightThresholdHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">ë†’ì„ìˆ˜ë¡ ë°ì€ ë¹›ì— ë¯¼ê°í•¨</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="odorThreshold">ëƒ„ìƒˆ ë¯¼ê°ë„</label>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="odorThreshold" name="odorThreshold" min="0" max="10" value="5" aria-describedby="odorThresholdHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="odorThresholdHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">ë†’ì„ìˆ˜ë¡ ëƒ„ìƒˆì— ë¯¼ê°í•¨</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="crowdThreshold">í˜¼ì¡ ë¯¼ê°ë„</label>
                        <div class="slider-container">
                            <input type="range" class="range-slider" id="crowdThreshold" name="crowdThreshold" min="0" max="10" value="5" aria-describedby="crowdThresholdHelp">
                            <div class="range-value">5</div>
                        </div>
                        <small id="crowdThresholdHelp" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">ë†’ì„ìˆ˜ë¡ í˜¼ì¡í•¨ì— ë¯¼ê°í•¨</small>
                    </div>

                    <button type="submit" class="primary-btn">
                        <i class="fas fa-user-check"></i>
                        í”„ë¡œí•„ ì €ì¥
                    </button>
                    
                    <button type="button" class="secondary-btn" id="cancelProfileBtn">
                        <i class="fas fa-times"></i>
                        ì·¨ì†Œ
                    </button>
                </form>
            </div>
        </aside>

        <!-- Route Controls -->
        <div class="route-controls" id="routeControls" aria-hidden="true">
            <div class="route-info">
                <div class="route-badge" id="routeStatus">ì¶œë°œì§€ ì„ íƒ</div>
            </div>
            
            <div class="route-options" id="routeOptions" style="display: none;">
                <button class="route-option-btn" id="sensoryRouteBtn">
                    <i class="fas fa-leaf" style="color:#10b981;"></i>
                    <div>
                        <div class="route-option-title">ê°ê° ìš°ì„ </div>
                        <div class="route-option-desc">ê°€ì¥ ì¾Œì í•œ ê²½ë¡œ</div>
                    </div>
                </button>
                <button class="route-option-btn balanced" id="balancedRouteBtn">
                    <i class="fas fa-balance-scale" style="color:#f59e0b;"></i>
                    <div>
                        <div class="route-option-title">ê· í˜•</div>
                        <div class="route-option-desc">ì¾Œì í•¨ê³¼ ì‹œê°„ì˜ ê· í˜•</div>
                    </div>
                </button>
                <button class="route-option-btn" id="timeRouteBtn">
                    <i class="fas fa-clock" style="color:#3b82f6;"></i>
                    <div>
                        <div class="route-option-title">ì‹œê°„ ìš°ì„ </div>
                        <div class="route-option-desc">ê°€ì¥ ë¹ ë¥¸ ê²½ë¡œ</div>
                    </div>
                </button>
            </div>
            
            <button class="secondary-btn" id="cancelRouteBtn">
                <i class="fas fa-times"></i>
                ì·¨ì†Œ
            </button>
        </div>

        <!-- Undo Action -->
        <div class="undo-action" id="undoAction" style="display: none;">
            <span class="undo-text">ê°ê° ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤</span>
            <button class="undo-btn" id="undoBtn">
                <i class="fas fa-undo"></i>
                ì‹¤í–‰ì·¨ì†Œ
            </button>
        </div>

        <!-- Toast Notifications -->
        <div class="toast" id="toast" role="alert" aria-live="polite"></div>

        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner" style="display: none;">
            <div class="alert-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="alertText"></span>
            </div>
            <button class="alert-close" id="alertClose" aria-label="ì•Œë¦¼ ë‹«ê¸°">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <!-- Clerk JavaScript SDK - ì˜¬ë°”ë¥¸ UMD ë°©ì‹ (ìˆ˜ì •ë¨) -->
    <script>
            // Clerk í‚¤ ì„¤ì • í•¨ìˆ˜ (ìˆ˜ì •ë¨)
            function getClerkPublishableKey() {
                const hostname = window.location.hostname;
                
                if (window.CLERK_PUBLISHABLE_KEY) {
                console.log('ğŸ”‘ Using server-injected key');
                return window.CLERK_PUBLISHABLE_KEY;
            }

            // Railway í™˜ê²½ ë³€ìˆ˜ëª… í™•ì¸
            if (window.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY) {
                console.log('ğŸ”‘ Using Railway-provided key');
                return window.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY;
            }
            
            // ë¡œì»¬ ê°œë°œ í™˜ê²½
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                console.log('ğŸ  Local development environment detected');
                return 'pk_test_cGVyZmVjdC1zdGFybGluZy05OC5jbGVyay5hY2NvdW50cy5kZXYk';
            }
            
            // Railwayë‚˜ ê¸°íƒ€ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ í‚¤ë¥¼ ì£¼ì…í•´ì•¼ í•¨
            console.warn('âš ï¸ No Clerk publishable key found for hostname:', hostname);
            return null;
        }
        
        // Clerk í‚¤ ì„¤ì •
        const clerkKey = getClerkPublishableKey();
        if (clerkKey) {
            window.CLERK_PUBLISHABLE_KEY = clerkKey;
            console.log('âœ… Clerk key configured');
        } else {
            console.error('âŒ No valid Clerk key available');
        }
    </script>
    
    <!-- Clerk SDK ë¡œë“œ (ì¡°ê±´ë¶€) -->
    <script>
        if (window.CLERK_PUBLISHABLE_KEY) {
            console.log('ğŸ“¦ Loading Clerk SDK...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@clerk/clerk-js@4.70.0/dist/clerk.browser.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.onload = () => console.log('âœ… Clerk SDK loaded successfully');
            script.onerror = () => console.error('âŒ Failed to load Clerk SDK');
            document.head.appendChild(script);
        } else {
            console.warn('âš ï¸ Skipping Clerk SDK load - no key available');
        }
    </script>
    
    <!-- Clerk ì¸ì¦ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ëœ ë²„ì „) -->
    <script>
        // ìˆ˜ì •ëœ AuthManager í´ë˜ìŠ¤ - UMD ë°©ì‹ì— ë§ê²Œ ì¡°ì •
        class AuthManager {
            constructor() {
                this.user = null;
                this.isAuthenticated = false;
                this.authToken = null;
                this.fallbackMode = false;
                this.isInitializing = false;
                this.initializationPromise = null;
            }

            // Clerk SDK ë¡œë“œ ëŒ€ê¸°
            async waitForClerkSDK(timeoutMs = 15000) {
                return new Promise((resolve, reject) => {
                    if (window.Clerk) {
                        console.log('âœ… Clerk SDK already available');
                        resolve(window.Clerk);
                        return;
                    }

                    console.log('â³ Waiting for Clerk SDK...');
                    
                    let attempts = 0;
                    const maxAttempts = timeoutMs / 200;
                    
                    const checkClerk = () => {
                        attempts++;
                        
                        if (window.Clerk) {
                            console.log('âœ… Clerk SDK loaded successfully');
                            resolve(window.Clerk);
                        } else if (attempts >= maxAttempts) {
                            console.error('âŒ Clerk SDK load timeout');
                            reject(new Error('Clerk SDK ë¡œë“œ ì‹œê°„ ì´ˆê³¼'));
                        } else {
                            setTimeout(checkClerk, 200);
                        }
                    };
                    
                    checkClerk();
                });
            }

            // Fallback ëª¨ë“œ ì´ˆê¸°í™”
            async initializeFallbackMode() {
                console.log('ğŸ”„ Fallback ëª¨ë“œë¡œ ì „í™˜: ì¸ì¦ ì—†ì´ ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰');
                
                this.isAuthenticated = false;
                this.fallbackMode = true;
                
                this.showFallbackMessage();
                this.showMainApp();
                
                return true;
            }

            showFallbackMessage() {
                const authOverlay = document.getElementById('authOverlay');
                const appContainer = document.getElementById('appContainer');
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                
                if (authLoadingOverlay) authLoadingOverlay.classList.add('hidden');
                if (authOverlay) authOverlay.classList.add('hidden');
                if (appContainer) appContainer.classList.remove('hidden');
                
                // ì‚¬ìš©ì ì •ë³´ ì˜ì—­ì— ë°ëª¨ ëª¨ë“œ í‘œì‹œ
                const userInfo = document.getElementById('userInfo');
                if (userInfo) {
                    userInfo.innerHTML = `
                        <div style="background: #fef3c7; color: #92400e; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                            ğŸ”„ ë°ëª¨ ëª¨ë“œ (ì¸ì¦ ì„œë¹„ìŠ¤ ì¼ì‹œ ë¶ˆê°€)
                        </div>
                    `;
                    userInfo.classList.remove('hidden');
                }
                
                // ì•Œë¦¼ ë°°ë„ˆ í‘œì‹œ
                setTimeout(() => {
                    this.showAlert('í˜„ì¬ ì¸ì¦ ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.', 'warning');
                }, 1000);
            }

            showAlert(message, type = 'info') {
                try {
                    const alertBanner = document.getElementById('alertBanner');
                    const alertText = document.getElementById('alertText');
                    
                    if (alertBanner && alertText) {
                        alertText.textContent = message;
                        alertBanner.className = `alert-banner ${type}`;
                        alertBanner.style.display = 'flex';
                    }
                } catch (error) {
                    console.warn('Alert í‘œì‹œ ì‹¤íŒ¨:', error);
                }
            }

            async initialize() {
                if (this.isInitializing && this.initializationPromise) {
                    return this.initializationPromise;
                }

                this.isInitializing = true;
                this.initializationPromise = this._doInitialize();
                
                try {
                    const result = await this.initializationPromise;
                    this.isInitializing = false;
                    return result;
                } catch (error) {
                    this.isInitializing = false;
                    throw error;
                }
            }

            async _doInitialize() {
                try {
                    console.log('ğŸš€ Starting Clerk initialization...');
                    
                    // Clerk í‚¤ í™•ì¸
                    const clerkKey = window.CLERK_PUBLISHABLE_KEY;
                    if (!clerkKey) {
                        console.warn('âš ï¸ No Clerk publishable key found, switching to fallback mode');
                        return await this.initializeFallbackMode();
                    }

                    console.log('ğŸ”‘ Using Clerk key:', clerkKey.substring(0, 20) + '...');

                    // Clerk SDK ëŒ€ê¸° - ë” ê¸´ ì‹œê°„ ëŒ€ê¸°
                    try {
                        await this.waitForClerkSDK(15000); // 15ì´ˆ ëŒ€ê¸°
                        
                        // Clerk ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” (UMD ë°©ì‹ì—ì„œëŠ” ì „ì—­ Clerk ê°ì²´ ì‚¬ìš©)
                        console.log('ğŸ”§ Initializing Clerk with key...');
                        
                        // UMD ë°©ì‹: window.Clerk.load()ì— í‚¤ ì „ë‹¬
                        await Promise.race([
                            window.Clerk.load({
                                publishableKey: clerkKey
                            }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Clerk initialization timeout')), 10000)
                            )
                        ]);

                        console.log('âœ… Clerk ì´ˆê¸°í™” ì™„ë£Œ');

                        // ì¸ì¦ ìƒíƒœ í™•ì¸
                        if (window.Clerk.user) {
                            this.user = window.Clerk.user;
                            this.isAuthenticated = true;
                            this.authToken = await window.Clerk.session?.getToken();
                            this.showMainApp();
                            this.updateUserInfo();
                            console.log('ğŸ‘¤ User already authenticated:', this.user.emailAddresses[0]?.emailAddress);
                        } else {
                            console.log('ğŸ”“ User not authenticated, showing login form');
                            this.showLoginForm();
                        }

                        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
                        window.Clerk.addListener('user', (user) => {
                            console.log('ğŸ‘¤ User state changed:', !!user);
                            if (user) {
                                this.user = user;
                                this.isAuthenticated = true;
                                this.showMainApp();
                                this.updateUserInfo();
                            } else {
                                this.user = null;
                                this.isAuthenticated = false;
                                this.authToken = null;
                                this.showLoginForm();
                            }
                        });

                        return true;

                    } catch (sdkError) {
                        console.error('âŒ Clerk SDK ë¡œë“œ/ì´ˆê¸°í™” ì‹¤íŒ¨:', sdkError);
                        
                        // íŠ¹ì • ì—ëŸ¬ì—ì„œë§Œ fallback, í‚¤ ê´€ë ¨ ì—ëŸ¬ëŠ” ì¬ì‹œë„
                        if (sdkError.message.includes('publishable key') || 
                            sdkError.message.includes('invalid') || 
                            sdkError.message.includes('unauthorized')) {
                            console.error('ğŸš¨ Clerk key validation failed:', sdkError.message);
                            this.showError('Clerk ì¸ì¦ í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ê²½ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            return false;
                        }
                        
                        // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“±ì€ fallback ëª¨ë“œë¡œ
                        return await this.initializeFallbackMode();
                    }

                } catch (error) {
                    console.error('âŒ Clerk ì´ˆê¸°í™” ìµœì¢… ì‹¤íŒ¨:', error);
                    return await this.initializeFallbackMode();
                }
            }

            showLoginForm() {
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                const authOverlay = document.getElementById('authOverlay');
                const appContainer = document.getElementById('appContainer');
                const userInfo = document.getElementById('userInfo');

                if (authLoadingOverlay) authLoadingOverlay.classList.add('hidden');
                if (authOverlay) authOverlay.classList.remove('hidden');
                if (appContainer) appContainer.classList.add('hidden');
                if (userInfo) userInfo.classList.add('hidden');

                // Clerk ë¡œê·¸ì¸ ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ (UMD ë°©ì‹)
                if (window.Clerk && !document.querySelector('.cl-component')) {
                    try {
                        console.log('ğŸ”§ Mounting Clerk sign-in component');
                        window.Clerk.mountSignIn(document.getElementById('clerk-signin'), {
                            routing: 'virtual',
                            appearance: {
                                elements: {
                                    formButtonPrimary: 'bg-blue-600 hover:bg-blue-700 text-white',
                                    card: 'shadow-lg'
                                }
                            }
                        });
                    } catch (error) {
                        console.error('âŒ Clerk UI ë§ˆìš´íŠ¸ ì‹¤íŒ¨:', error);
                        this.showError('ë¡œê·¸ì¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
            }

            showMainApp() {
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                const authOverlay = document.getElementById('authOverlay');
                const appContainer = document.getElementById('appContainer');
                const userInfo = document.getElementById('userInfo');

                if (authLoadingOverlay) authLoadingOverlay.classList.add('hidden');
                if (authOverlay) authOverlay.classList.add('hidden');
                if (appContainer) appContainer.classList.remove('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
            }

            updateUserInfo() {
                if (this.user) {
                    const userName = this.user.firstName || this.user.emailAddresses[0].emailAddress.split('@')[0];
                    const userAvatar = this.user.imageUrl || 'https://via.placeholder.com/32';

                    const userNameEl = document.getElementById('userName');
                    const userAvatarEl = document.getElementById('userAvatar');
                    
                    if (userNameEl) userNameEl.textContent = userName;
                    if (userAvatarEl) userAvatarEl.src = userAvatar;
                }
            }

            async getAuthToken() {
                if (this.fallbackMode) {
                    return null;
                }
                
                if (window.Clerk && window.Clerk.session) {
                    try {
                        this.authToken = await window.Clerk.session.getToken();
                    } catch (error) {
                        console.warn('í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                        return null;
                    }
                }
                return this.authToken;
            }

            async logout() {
                if (window.Clerk) {
                    try {
                        await window.Clerk.signOut();
                    } catch (error) {
                        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                    }
                } else if (this.fallbackMode) {
                    window.location.reload();
                }
            }

            showError(message) {
                console.error('ğŸš¨ Auth Error:', message);
                
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                const authOverlay = document.getElementById('authOverlay');
                const authError = document.getElementById('auth-error');

                if (authLoadingOverlay) authLoadingOverlay.classList.add('hidden');
                if (authOverlay) authOverlay.classList.remove('hidden');
                if (authError) {
                    authError.classList.remove('hidden');
                    authError.textContent = message;
                }
            }
        }

        // ì „ì—­ AuthManager ì¸ìŠ¤í„´ìŠ¤
        window.authManager = new AuthManager();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸŒŸ DOM loaded, starting authentication...');
            
            try {
                await window.authManager.initialize();
                console.log('âœ… Authentication initialization completed');

                // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await window.authManager.logout();
                        } catch (error) {
                            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                        }
                    });
                }

                // ì•Œë¦¼ ë°°ë„ˆ ë‹«ê¸° ë²„íŠ¼
                const alertClose = document.getElementById('alertClose');
                if (alertClose) {
                    alertClose.addEventListener('click', () => {
                        const alertBanner = document.getElementById('alertBanner');
                        if (alertBanner) {
                            alertBanner.style.display = 'none';
                        }
                    });
                }

            } catch (error) {
                console.error('ğŸ’¥ Authentication initialization failed:', error);
                await window.authManager.initializeFallbackMode();
            }
        });

        // script.js ì¸ì¦ ëŒ€ê¸° ë¡œì§ ìˆ˜ì •
        document.addEventListener('DOMContentLoaded', () => {
            // AuthManagerê°€ ì´ˆê¸°í™”ëœ í›„ ì‹¤í–‰
            const checkAuthAndInitApp = () => {
                if (window.authManager) {
                    // AuthManagerê°€ ì¤€ë¹„ë˜ë©´ ì•± ì´ˆê¸°í™”
                    if (window.sensmapApp && window.sensmapApp.waitForAuth) {
                        // ê¸°ì¡´ waitForAuth ë©”ì„œë“œë¥¼ ìˆ˜ì •
                        window.sensmapApp.waitForAuth = async function() {
                            // ì¸ì¦ ì™„ë£Œë˜ê±°ë‚˜ fallback ëª¨ë“œì¼ ë•Œê¹Œì§€ ëŒ€ê¸°
                            while (!window.authManager || 
                                   (!window.authManager.isAuthenticated && !window.authManager.fallbackMode)) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                            
                            console.log('âœ… Auth ready - authenticated:', window.authManager.isAuthenticated, 'fallback:', window.authManager.fallbackMode);
                            
                            // ì•± ì´ˆê¸°í™” ì‹¤í–‰
                            await this.initializeApp();
                        };
                    }
                } else {
                    // AuthManagerê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
                    setTimeout(checkAuthAndInitApp, 100);
                }
            };
            
            checkAuthAndInitApp();
        });

        // API ìš”ì²­ ì‹œ ì¸ì¦ í† í°ì„ í¬í•¨í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        window.authenticatedFetch = async (url, options = {}) => {
            try {
                const token = await window.authManager.getAuthToken();
                
                const headers = {
                    ...options.headers,
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                return fetch(url, {
                    ...options,
                    headers
                });
            } catch (error) {
                console.error('ì¸ì¦ëœ ìš”ì²­ ì‹¤íŒ¨:', error);
                throw error;
            }
        };

        // ë””ë²„ê¹…ì„ ìœ„í•œ ì „ì—­ í•¨ìˆ˜
        window.debugAuth = () => {
            console.log('ğŸ” Auth Debug Info:');
            console.log('- AuthManager exists:', !!window.authManager);
            console.log('- Clerk SDK loaded:', !!window.Clerk);
            console.log('- Is authenticated:', window.authManager?.isAuthenticated);
            console.log('- Fallback mode:', window.authManager?.fallbackMode);
            console.log('- User:', window.authManager?.user ? 'Logged in' : 'Not logged in');
        };
    </script>
    
    <!-- ê¸°ì¡´ ë©”ì¸ ì•± ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="script.js"></script>

    <!-- Performance monitoring -->
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('ğŸš€ Page load time:', Math.round(perfData.loadEventEnd - perfData.fetchStart), 'ms');
            }, 100);
        });
    </script>
</body>
</html>