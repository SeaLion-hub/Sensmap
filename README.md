# Sensmap
20250826 길찾기 알고리즘 업데이트
1171줄과 1607줄의 계수 변경으로 감도 설정 가능 이걸로 개선 가능할듯. 그리고 초기에 출발점과 도착점 주변만 분석하도록 했는데 그 주변 범위 설정하는 것도 방법일듯
알고리즘 설명 :
Baseline 확보: ORS를 회피 없이 호출(소수 alternates)→ 가장 빠른 경로를 baseline으로 잡음.

적응형 퍼센타일 p: routeType(sensory/balanced/time)과 **거리(km)**에 따라 p를 설정(멀수록 p↓).
(p퍼센타일% 이상의 감각 농도를 지닌 점을 절대 안지나가게 한다라고 생각하면 됨. 이후 k-means 군집화를 통해서 점을 묶어서 면적화함)
소프트/하드 회피 생성:

하드: 평균−kσ 이하(극단값) 셀 → k-means → hull → 큰 버퍼로 폴리곤.
(면적을 크게 쪼개서 못지나가게함)

소프트: 하위 p% 셀(극단 제외) → k-means → hull → 작은 버퍼 폴리곤.
(면적을 잘게 쪼개서 지나갈 틈 생김)

routeType은 p퍼센타일%/버퍼 크기/폴리곤 개수만 다르게. --> (p0값과 버퍼 크기가 곧 감각 반영 정도)

ORS 대안 호출: avoid_polygons + alternative_routes로 후보 수집(GeoJSON).

가드레일: baseline 대비 detour 비율(r)과 쾌적도 개선율(네 calculateRouteSensoryScore)로 후보 필터. (r값으로 너무 돌아가는 경우를 막음. 이건 좀 논의가 필요할듯)

완화 루프: 조건 불충족 시 p·버퍼·폴리곤 수를 줄여 2~3회 재시도.

최종 선택: baseline + 대안 후보 풀에서 기존 selectBestRoute()로 최종 1개 선택 후 표시.
(기존 기본 알고리즘은 감각 반영 x로 최단 경로만 4개 받고 그 4개중 가장 나은 것 내보내는 거였는데 이번건 경로 4개 받는건 같지만 감각이 반영되어있음)



1171줄 계수 설정 :
p0 : 시작 퍼센타일(하위 p0만 “소프트 회피” 후보). ↑면 더 많이 피해요.

rCap : 베이스라인 대비 허용 우회 한계(시간 비율). 1.25면 +25%까지만 허용. ↓면 더 직선 위주.

minGain : 쾌적도 개선율 최소치. ↑면 “확실히 더 쾌적한” 경로만 채택.

tries : 완화 루프 최대 회수(퍼센타일/버퍼 줄여 재시도). ↑면 더 집요하게 대안 탐색(호출 증가).

corridorM : 코리도 반폭(m). ↑면 더 넓은 영역을 스캔→회피 폴리곤 더 커질 가능성.

kSigma : 극단값(하드 회피) 임계의 표준편차 계수. ↓면 “극단적으로 나쁨”으로 더 많이 분류.

빠른 튜닝 가이드

너무 멀리 우회한다 → p0↓, corridorM↓, rCap↓(예: 1.15→1.10), kSigma↑.

대안이 너무 비슷하다 → p0↑, corridorM↑, kSigma↓(극단값 더 민감), tries↑.

쾌적도 개선 체감이 적다 → minGain↑(예: 0.05→0.08).

호출이 많아진다 → tries↓(2), p0↓로 초전에 덜 공격적으로.

같이 기억하면 좋은 것

폴리곤의 버퍼 크기/최대 개수는 _buffersForType()에서 따로 조절돼요(면적 감).

ORS 한도(대안 최대 3, 회피 폴리곤 크기 제한 등) 때문에, 값들을 너무 공격적으로 올리면 실패율이 올라갈 수 있어요.





1607줄 버퍼 설정 :
soft (m): 퍼센타일 기반 “소프트 회피” 폴리곤의 팽창(버퍼) 폭 → 작게 피해감.

hard (m): 극단적으로 나쁜 셀(평균−kσ 이하) 군집의 하드 회피 버퍼 → 크게 피해감.

polyMax: ORS에 보낼 회피 폴리곤 최대 개수(요청 크기·레이트리밋 보호).

튜닝 감

더 많이 피해가고 싶다 → soft/hard↑, polyMax↑

우회가 과하다 → soft/hard↓, polyMax↓

time 타입이 값이 가장 작게 잡힌 이유 = “우회 억제” 목적

즉, 속도/가중치를 건드리지 않고 면적(버퍼)·개수만으로 routeType 성향을 바꾸는 핵심 파라미터 세트입니다.